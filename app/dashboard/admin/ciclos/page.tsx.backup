'use client';

import { useState, useEffect } from 'react';
import { Search, Loader2, Users, RefreshCw } from 'lucide-react';
import AdminUserControl from '@/components/dashboard/AdminUserControl';

export default function AdminCycleManagement() {
  const [searchTerm, setSearchTerm] = useState('');
  const [searching, setSearching] = useState(false);
  const [userData, setUserData] = useState<any>(null);
  const [error, setError] = useState('');

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!searchTerm.trim()) {
      setError('Ingresa un ID de usuario');
      return;
    }

    setSearching(true);
    setError('');
    setUserData(null);

    try {
      const res = await fetch(`/api/admin/user/${searchTerm}`);
      const data = await res.json();

      if (res.ok) {
        setUserData(data);
      } else {
        setError(data.error || 'Usuario no encontrado');
      }
    } catch (err) {
      console.error('Error:', err);
      setError('Error al buscar usuario');
    } finally {
      setSearching(false);
    }
  };

  const handleRefresh = () => {
    if (searchTerm) {
      handleSearch({ preventDefault: () => {} } as any);
    }
  };

  return (
    <div className="min-h-screen bg-[#0f1015] p-6">
      <div className="max-w-7xl mx-auto">
        
        {/* HEADER */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-white flex items-center gap-3 mb-2">
            <Users className="text-purple-400" size={32} />
            Gesti√≥n de Ciclos de Usuario
          </h1>
          <p className="text-gray-400">
            Consola de comandante: Control total sobre el ciclo de cada usuario
          </p>
        </div>

        {/* BUSCADOR */}
        <div className="bg-[#1a1b1f] border border-gray-800 rounded-xl p-6 mb-6">
          <form onSubmit={handleSearch} className="flex gap-3">
            <div className="flex-1 relative">
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500" size={20} />
              <input
                type="number"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Ingresa el ID del usuario..."
                className="w-full bg-gray-900 text-white pl-12 pr-4 py-3 rounded-lg border border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition-all"
              />
            </div>
            <button
              type="submit"
              disabled={searching}
              className="px-6 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
            >
              {searching ? (
                <>
                  <Loader2 size={20} className="animate-spin" />
                  Buscando...
                </>
              ) : (
                <>
                  <Search size={20} />
                  Buscar
                </>
              )}
            </button>
          </form>

          {error && (
            <div className="mt-4 bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-red-400 text-sm">
              ‚ùå {error}
            </div>
          )}
        </div>

        {/* RESULTADO */}
        {userData && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">
                Informaci√≥n del Usuario
              </h2>
              <button
                onClick={handleRefresh}
                className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-all"
              >
                <RefreshCw size={16} />
                Actualizar
              </button>
            </div>

            <AdminUserControl
              user={userData.user}
              vision={userData.vision}
              enrollment={userData.enrollment}
              carta={userData.carta}
              stats={userData.stats}
              onRefresh={handleRefresh}
            />

            {/* INFORMACI√ìN ADICIONAL */}
            {userData.carta && (
              <div className="bg-[#1a1b1f] border border-gray-800 rounded-xl p-6">
                <h3 className="text-lg font-bold text-white mb-4">
                  Vista Previa de Carta F.R.U.T.O.S.
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* FINANZAS */}
                  <div className="bg-gray-900/50 rounded-lg p-4">
                    <h4 className="text-green-400 font-bold mb-2 flex items-center gap-2">
                      üí∞ FINANZAS
                    </h4>
                    <p className="text-xs text-gray-400 mb-2">
                      <strong>Identidad:</strong><br />
                      {userData.carta.finanzasDeclaracion || <em className="text-gray-600">No definida</em>}
                    </p>
                    <p className="text-xs text-gray-400">
                      <strong>Meta:</strong><br />
                      {userData.carta.finanzasMeta || <em className="text-gray-600">No definida</em>}
                    </p>
                  </div>

                  {/* RELACIONES */}
                  <div className="bg-gray-900/50 rounded-lg p-4">
                    <h4 className="text-pink-400 font-bold mb-2 flex items-center gap-2">
                      ‚ù§Ô∏è RELACIONES
                    </h4>
                    <p className="text-xs text-gray-400 mb-2">
                      <strong>Identidad:</strong><br />
                      {userData.carta.relacionesDeclaracion || <em className="text-gray-600">No definida</em>}
                    </p>
                    <p className="text-xs text-gray-400">
                      <strong>Meta:</strong><br />
                      {userData.carta.relacionesMeta || <em className="text-gray-600">No definida</em>}
                    </p>
                  </div>

                  {/* SALUD */}
                  <div className="bg-gray-900/50 rounded-lg p-4">
                    <h4 className="text-blue-400 font-bold mb-2 flex items-center gap-2">
                      üí™ SALUD
                    </h4>
                    <p className="text-xs text-gray-400 mb-2">
                      <strong>Identidad:</strong><br />
                      {userData.carta.saludDeclaracion || <em className="text-gray-600">No definida</em>}
                    </p>
                    <p className="text-xs text-gray-400">
                      <strong>Meta:</strong><br />
                      {userData.carta.saludMeta || <em className="text-gray-600">No definida</em>}
                    </p>
                  </div>

                  {/* PAZ MENTAL */}
                  <div className="bg-gray-900/50 rounded-lg p-4">
                    <h4 className="text-cyan-400 font-bold mb-2 flex items-center gap-2">
                      üßò PAZ MENTAL
                    </h4>
                    <p className="text-xs text-gray-400 mb-2">
                      <strong>Identidad:</strong><br />
                      {userData.carta.pazMentalDeclaracion || <em className="text-gray-600">No definida</em>}
                    </p>
                    <p className="text-xs text-gray-400">
                      <strong>Meta:</strong><br />
                      {userData.carta.pazMentalMeta || <em className="text-gray-600">No definida</em>}
                    </p>
                  </div>

                  {/* M√°s √°reas... (acortado para brevedad) */}
                </div>

                {userData.carta.metas && userData.carta.metas.length > 0 && (
                  <div className="mt-6">
                    <h4 className="text-white font-bold mb-3">
                      Acciones Configuradas ({userData.carta.metas.length} metas)
                    </h4>
                    <div className="space-y-2">
                      {userData.carta.metas.map((meta: any) => (
                        <div key={meta.id} className="bg-gray-900/50 rounded p-3 text-xs">
                          <div className="text-purple-400 font-bold">{meta.categoria}</div>
                          <div className="text-gray-400 mt-1">
                            {meta.Accion?.length || 0} acciones definidas
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* PLACEHOLDER INICIAL */}
        {!userData && !searching && !error && (
          <div className="bg-[#1a1b1f] border border-gray-800 rounded-xl p-12 text-center">
            <Users className="text-gray-700 mx-auto mb-4" size={64} />
            <h3 className="text-xl font-bold text-gray-500 mb-2">
              Busca un usuario para comenzar
            </h3>
            <p className="text-gray-600 text-sm">
              Ingresa el ID del usuario en el buscador de arriba
            </p>
          </div>
        )}

      </div>
    </div>
  );
}
